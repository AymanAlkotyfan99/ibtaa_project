<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Subscription Plans | AETHER</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Space+Grotesk:wght@300;500;700&display=swap"
      rel="stylesheet"
    />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css" />

    <!-- Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
  </head>
  <body class="bg-black text-white overflow-x-hidden">
    <!-- Custom Cursor -->
    <div class="cursor-dot"></div>
    <div class="cursor-outline"></div>

    <!-- WebGL Background -->
    <canvas id="webgl-canvas"></canvas>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg fixed-top p-4">
      <div class="container-fluid">
        <a
          class="navbar-brand text-white fw-bold fs-3 tracking-in-expand"
          href="index.html"
          >AETHER</a
        >
        <div class="collapse navbar-collapse justify-content-end">
          <ul class="navbar-nav gap-4 align-items-center">
            <li class="nav-item">
              <a
                class="nav-link text-uppercase text-white-50 hover-glow"
                href="dashboard.html"
                >Dashboard</a
              >
            </li>
            <li class="nav-item">
              <span id="userRole" class="text-white-50 small me-2"></span>
            </li>
            <li class="nav-item">
              <button
                id="logoutBtn"
                class="btn btn-sm btn-outline-light rounded-pill px-4"
              >
                Disconnect
              </button>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Subscription Plans Section -->
    <section class="section-padding pt-5 mt-5 position-relative z-2">
      <div class="container">
        <div class="row mb-5">
          <div class="col-12 d-flex justify-content-between align-items-center">
            <div>
              <h1 class="display-4 fw-bold hero-reveal">
                Subscription Plans
              </h1>
              <p class="text-white-50 lead hero-reveal">
                Configure merchant subscription tiers and pricing.
              </p>
            </div>
            <button
              class="btn btn-custom btn-lg magnetic-btn"
              onclick="showAddPlanModal()"
            >
              <i class="bi bi-plus-circle me-2"></i>Add Plan
            </button>
          </div>
        </div>

        <!-- Plans Grid -->
        <div id="plansGrid" class="row g-4">
          <!-- Plans loaded dynamically -->
          <div class="col-12 text-center text-white-50 py-5">
            <p>Loading subscription plans...</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Add/Edit Plan Modal -->
    <div class="modal fade" id="planModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-dark text-white border-secondary">
          <div class="modal-header border-secondary">
            <h5 class="modal-title" id="planModalTitle">Add Subscription Plan</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="planForm">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label text-white-50">Plan Name</label>
                  <input type="text" id="planName" class="form-control bg-transparent text-white border-secondary" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label text-white-50">Price ($)</label>
                  <input type="number" id="planPrice" class="form-control bg-transparent text-white border-secondary" min="0" step="0.01" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label text-white-50">Duration (Days)</label>
                  <input type="number" id="planDuration" class="form-control bg-transparent text-white border-secondary" min="1" required>
                </div>
                <div class="col-md-6">
                  <label class="form-label text-white-50">Max Products</label>
                  <input type="number" id="planMaxProducts" class="form-control bg-transparent text-white border-secondary" min="0" placeholder="Unlimited">
                </div>
                <div class="col-12">
                  <label class="form-label text-white-50">Description</label>
                  <textarea id="planDescription" class="form-control bg-transparent text-white border-secondary" rows="3"></textarea>
                </div>
                <div class="col-12">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="planIsActive">
                    <label class="form-check-label text-white-50" for="planIsActive">
                      Plan is Active
                    </label>
                  </div>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer border-secondary">
            <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-custom" onclick="savePlan()">Save Plan</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>

    <!-- Custom Script -->
    <script src="script.js"></script>
    <script>
      const API_BASE = 'http://localhost:8000/api';

      // Check authentication
      const token = localStorage.getItem('access_token');
      const user = JSON.parse(localStorage.getItem('user') || '{}');

      if (!token || user.role !== 'ADMIN') {
        window.location.href = 'login.html';
      }

      document.getElementById('userRole').textContent = `${user.role || 'USER'} PROTOCOL`;

      // Logout handler
      document.getElementById('logoutBtn').addEventListener('click', function() {
        localStorage.removeItem('access_token');
        localStorage.removeItem('refresh_token');
        localStorage.removeItem('user');
        window.location.href = 'login.html';
      });

      // API helper with auth
      async function apiCall(endpoint, options = {}) {
        const headers = {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
          ...options.headers
        };

        const response = await fetch(`${API_BASE}${endpoint}`, {
          ...options,
          headers
        });

        if (response.status === 401) {
          localStorage.removeItem('access_token');
          window.location.href = 'login.html';
        }

        return response;
      }

      let currentPlanId = null;

      // Load plans
      async function loadPlans() {
        try {
          const response = await apiCall('/admin/settings/');
          const data = await response.json();

          // Handle subscription_plans - should be an array
          let plans = data.subscription_plans || [];
          
          // If it's a string, parse it
          if (typeof plans === 'string') {
            try {
              plans = JSON.parse(plans);
            } catch (e) {
              plans = [];
            }
          }
          
          // Ensure it's an array
          if (!Array.isArray(plans)) {
            plans = [];
          }
          
          renderPlans(plans);
        } catch (error) {
          console.error('Error loading plans:', error);
          document.getElementById('plansGrid').innerHTML = '<div class="col-12 text-center text-danger py-5"><p>Error loading plans. Please try again.</p></div>';
        }
      }

      function renderPlans(plans) {
        const grid = document.getElementById('plansGrid');
        if (plans.length === 0) {
          grid.innerHTML = '<div class="col-12 text-center text-white-50 py-5"><p>No subscription plans configured yet.</p></div>';
        } else {
          grid.innerHTML = plans.map((plan, index) => `
            <div class="col-md-6 col-lg-4">
              <div class="glass-card p-4 h-100 reveal-scale">
                <div class="d-flex justify-content-between align-items-start mb-3">
                  <h4 class="mb-0">${plan.name}</h4>
                  <div class="dropdown">
                    <button class="btn btn-sm btn-outline-light" type="button" data-bs-toggle="dropdown">
                      <i class="bi bi-three-dots"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-dark">
                      <li><a class="dropdown-item" href="#" onclick="editPlan(${index})">Edit</a></li>
                      <li><a class="dropdown-item text-danger" href="#" onclick="deletePlan(${index})">Delete</a></li>
                    </ul>
                  </div>
                </div>
                <p class="display-5 text-accent fw-bold mb-2">$${plan.price}</p>
                <p class="text-white-50 mb-2">${plan.duration_days} days</p>
                ${plan.max_products ? `<p class="text-white-50 small mb-2">Max ${plan.max_products} products</p>` : ''}
                <p class="text-white-50 small mb-3">${plan.description || 'No description'}</p>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="badge bg-${plan.is_active ? 'success' : 'secondary'}">${plan.is_active ? 'Active' : 'Inactive'}</span>
                </div>
              </div>
            </div>
          `).join('');
        }
      }

      function showAddPlanModal() {
        currentPlanId = null;
        document.getElementById('planModalTitle').textContent = 'Add Subscription Plan';
        document.getElementById('planForm').reset();
        document.getElementById('planIsActive').checked = true;

        const modal = new bootstrap.Modal(document.getElementById('planModal'));
        modal.show();
      }

      function editPlan(index) {
        // This is a simplified version - in reality, we'd need to load the full settings and modify the array
        alert('Edit functionality requires backend endpoint for individual plan updates. This is a placeholder.');
      }

      function deletePlan(index) {
        if (!confirm('Are you sure you want to delete this plan? This action cannot be undone.')) return;
        alert('Delete functionality requires backend endpoint. This is a placeholder.');
      }

      async function savePlan() {
        const form = document.getElementById('planForm');
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        const planData = {
          name: document.getElementById('planName').value,
          price: parseFloat(document.getElementById('planPrice').value),
          duration_days: parseInt(document.getElementById('planDuration').value),
          max_products: document.getElementById('planMaxProducts').value ? parseInt(document.getElementById('planMaxProducts').value) : null,
          description: document.getElementById('planDescription').value,
          is_active: document.getElementById('planIsActive').checked
        };

        try {
          // Load current settings
          const response = await apiCall('/admin/settings/');
          const settings = await response.json();

          // Ensure subscription_plans is an array
          let plans = settings.subscription_plans || [];
          if (typeof plans === 'string') {
            try {
              plans = JSON.parse(plans);
            } catch (e) {
              plans = [];
            }
          }

          if (currentPlanId !== null) {
            // Edit existing plan
            plans[currentPlanId] = planData;
          } else {
            // Add new plan
            plans.push(planData);
          }

          // Prepare update payload
          const updatePayload = {
            ...settings,
            subscription_plans: plans
          };

          // Save updated settings
          const saveResponse = await apiCall('/admin/settings/', {
            method: 'PATCH',
            body: JSON.stringify(updatePayload)
          });

          if (saveResponse.ok) {
            alert('Plan saved successfully!');
            bootstrap.Modal.getInstance(document.getElementById('planModal')).hide();
            loadPlans();
          } else {
            const data = await saveResponse.json();
            alert(data.detail || 'Error saving plan');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Connection error. Please try again.');
        }
      }

      // Initialize
      loadPlans();
    </script>
  </body>
</html>