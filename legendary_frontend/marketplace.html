<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Marketplace | AETHER</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Space+Grotesk:wght@300;500;700&display=swap"
      rel="stylesheet"
    />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css" />

    <!-- Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
  </head>
  <body class="bg-black text-white overflow-x-hidden">
    <!-- Custom Cursor -->
    <div class="cursor-dot"></div>
    <div class="cursor-outline"></div>

    <!-- WebGL Background -->
    <canvas id="webgl-canvas"></canvas>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg fixed-top p-4">
      <div class="container-fluid">
        <a
          class="navbar-brand text-white fw-bold fs-3 tracking-in-expand"
          href="index.html"
          >AETHER</a
        >
        <div class="collapse navbar-collapse justify-content-end">
          <ul class="navbar-nav gap-4 align-items-center">
            <li class="nav-item">
              <a
                class="nav-link text-uppercase text-white-50 hover-glow"
                href="dashboard.html"
                >Dashboard</a
              >
            </li>
            <li class="nav-item">
              <span id="userRole" class="text-white-50 small me-2"></span>
            </li>
            <li class="nav-item">
              <button
                id="logoutBtn"
                class="btn btn-sm btn-outline-light rounded-pill px-4"
              >
                Disconnect
              </button>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Marketplace Section -->
    <section class="section-padding pt-5 mt-5 position-relative z-2">
      <div class="container">
        <div class="row mb-5">
          <div class="col-12">
            <h1 class="display-4 fw-bold hero-reveal">
              Premium Marketplace
            </h1>
            <p class="text-white-50 lead hero-reveal">
              Discover exclusive assets from verified merchants.
            </p>
          </div>
        </div>

        <!-- Filters -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="glass-card p-4 reveal-up">
              <div class="row g-3 align-items-end">
                <div class="col-md-4">
                  <label class="text-white-50 mb-2">Search Products</label>
                  <input
                    type="text"
                    id="searchInput"
                    class="form-control bg-transparent text-white border-0 border-bottom rounded-0 p-2"
                    placeholder="Search by name..."
                  />
                </div>
                <div class="col-md-3">
                  <label class="text-white-50 mb-2">Merchant</label>
                  <select
                    id="merchantFilter"
                    class="form-select bg-transparent text-white border-0 border-bottom rounded-0 p-2"
                  >
                    <option value="" class="bg-dark">All Merchants</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="text-white-50 mb-2">Sort By</label>
                  <select
                    id="sortSelect"
                    class="form-select bg-transparent text-white border-0 border-bottom rounded-0 p-2"
                  >
                    <option value="name" class="bg-dark">Name</option>
                    <option value="price_low" class="bg-dark">Price: Low to High</option>
                    <option value="price_high" class="bg-dark">Price: High to Low</option>
                    <option value="newest" class="bg-dark">Newest</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <button
                    id="applyFilters"
                    class="btn btn-custom btn-lg w-100 magnetic-btn"
                  >
                    Apply Filters
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Product Grid -->
        <div id="productGrid" class="row g-4">
          <!-- Products loaded dynamically -->
          <div class="col-12 text-center text-white-50 py-5">
            <p>Loading premium assets...</p>
          </div>
        </div>

        <!-- Pagination -->
        <div class="row mt-5">
          <div class="col-12 text-center">
            <nav id="paginationNav" aria-label="Product pagination">
              <!-- Pagination loaded dynamically -->
            </nav>
          </div>
        </div>
      </div>
    </section>

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>

    <!-- Custom Script -->
    <script src="script.js"></script>
    <script>
      const API_BASE = 'http://localhost:8000/api';

      // Check authentication
      const token = localStorage.getItem('access_token');
      const user = JSON.parse(localStorage.getItem('user') || '{}');

      if (!token || user.role !== 'CUSTOMER') {
        window.location.href = 'login.html';
      }

      document.getElementById('userRole').textContent = `${user.role || 'USER'} PROTOCOL`;

      // Logout handler
      document.getElementById('logoutBtn').addEventListener('click', function() {
        localStorage.removeItem('access_token');
        localStorage.removeItem('refresh_token');
        localStorage.removeItem('user');
        window.location.href = 'login.html';
      });

      // API helper with auth
      async function apiCall(endpoint, options = {}) {
        const headers = {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
          ...options.headers
        };

        const response = await fetch(`${API_BASE}${endpoint}`, {
          ...options,
          headers
        });

        if (response.status === 401) {
          localStorage.removeItem('access_token');
          window.location.href = 'login.html';
        }

        return response;
      }

      let currentPage = 1;
      let currentFilters = {
        search: '',
        merchant: '',
        sort: 'name'
      };

      // Load products
      async function loadProducts(page = 1, filters = {}) {
        try {
          let url = `/customer/products/?page=${page}`;
          if (filters.search) url += `&search=${encodeURIComponent(filters.search)}`;
          if (filters.merchant) url += `&merchant=${filters.merchant}`;
          if (filters.sort) url += `&ordering=${filters.sort}`;

          const response = await apiCall(url);
          const data = await response.json();

          renderProducts(data.results || data);
          renderPagination(data);
        } catch (error) {
          console.error('Error loading products:', error);
          document.getElementById('productGrid').innerHTML = '<div class="col-12 text-center text-danger py-5"><p>Error loading products. Please try again.</p></div>';
        }
      }

      function renderProducts(products) {
        const grid = document.getElementById('productGrid');
        if (products.length === 0) {
          grid.innerHTML = '<div class="col-12 text-center text-white-50 py-5"><p>No products found matching your criteria.</p></div>';
        } else {
          grid.innerHTML = products.map(p => `
            <div class="col-md-6 col-lg-4">
              <div class="glass-card p-0 overflow-hidden reveal-scale model-card">
                <div class="bg-secondary" style="height: 200px; background: linear-gradient(135deg, #1a1a2e, #16213e); display: flex; align-items: center; justify-content: center;">
                  <i class="bi bi-box-seam display-1 text-white-50"></i>
                </div>
                <div class="p-4">
                  <h5 class="mb-2">${p.name}</h5>
                  <p class="text-white-50 small mb-2">${p.merchant_name || 'Verified Merchant'}</p>
                  <p class="text-accent fw-bold mb-3">$${p.price}</p>
                  <div class="d-flex gap-2">
                    <button class="btn btn-outline-light btn-sm flex-fill" onclick="viewProduct(${p.id})">
                      <i class="bi bi-eye me-1"></i>View
                    </button>
                    <button class="btn btn-custom btn-sm flex-fill" onclick="orderProduct(${p.id})">
                      <i class="bi bi-cart-plus me-1"></i>Acquire
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `).join('');
        }
      }

      function renderPagination(data) {
        const nav = document.getElementById('paginationNav');
        // Simple pagination - assuming data has next/previous or count
        nav.innerHTML = '';
        if (data.next || data.previous) {
          const ul = document.createElement('ul');
          ul.className = 'pagination pagination-lg justify-content-center';

          if (data.previous) {
            ul.innerHTML += `<li class="page-item"><a class="page-link text-white bg-transparent border-secondary" href="#" onclick="changePage(${currentPage - 1})">Previous</a></li>`;
          }

          ul.innerHTML += `<li class="page-item active"><a class="page-link text-white bg-secondary border-secondary" href="#">${currentPage}</a></li>`;

          if (data.next) {
            ul.innerHTML += `<li class="page-item"><a class="page-link text-white bg-transparent border-secondary" href="#" onclick="changePage(${currentPage + 1})">Next</a></li>`;
          }

          nav.appendChild(ul);
        }
      }

      function changePage(page) {
        currentPage = page;
        loadProducts(currentPage, currentFilters);
      }

      // Load merchants for filter
      async function loadMerchants() {
        try {
          const response = await apiCall('/customer/products/');
          const products = await response.json();
          const merchants = [...new Set(products.map(p => p.merchant_name).filter(Boolean))];

          const select = document.getElementById('merchantFilter');
          merchants.forEach(merchant => {
            const option = document.createElement('option');
            option.value = merchant;
            option.textContent = merchant;
            option.className = 'bg-dark';
            select.appendChild(option);
          });
        } catch (error) {
          console.error('Error loading merchants:', error);
        }
      }

      // Filter handlers
      document.getElementById('applyFilters').addEventListener('click', function() {
        currentFilters = {
          search: document.getElementById('searchInput').value,
          merchant: document.getElementById('merchantFilter').value,
          sort: document.getElementById('sortSelect').value
        };
        currentPage = 1;
        loadProducts(currentPage, currentFilters);
      });

      // Enter key for search
      document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          document.getElementById('applyFilters').click();
        }
      });

      function viewProduct(productId) {
        // For now, just alert - could link to product detail page
        alert('Product detail page coming soon! Product ID: ' + productId);
      }

      async function orderProduct(productId) {
        if (!confirm('Are you sure you want to acquire this asset?')) return;

        try {
          const response = await apiCall('/customer/orders/', {
            method: 'POST',
            body: JSON.stringify({ product: productId })
          });

          if (response.ok) {
            alert('Asset acquired successfully!');
            // Could refresh or update UI
          } else {
            const data = await response.json();
            alert(data.detail || 'Error acquiring asset');
          }
        } catch (error) {
          alert('Connection error. Please try again.');
        }
      }

      // Initialize
      loadMerchants();
      loadProducts();
    </script>
  </body>
</html>