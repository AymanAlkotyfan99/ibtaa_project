<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>User Management | AETHER</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Space+Grotesk:wght@300;500;700&display=swap"
      rel="stylesheet"
    />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css" />

    <!-- Icons -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
    />
  </head>
  <body class="bg-black text-white overflow-x-hidden">
    <!-- Custom Cursor -->
    <div class="cursor-dot"></div>
    <div class="cursor-outline"></div>

    <!-- WebGL Background -->
    <canvas id="webgl-canvas"></canvas>

    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg fixed-top p-4">
      <div class="container-fluid">
        <a
          class="navbar-brand text-white fw-bold fs-3 tracking-in-expand"
          href="index.html"
          >AETHER</a
        >
        <div class="collapse navbar-collapse justify-content-end">
          <ul class="navbar-nav gap-4 align-items-center">
            <li class="nav-item">
              <a
                class="nav-link text-uppercase text-white-50 hover-glow"
                href="dashboard.html"
                >Dashboard</a
              >
            </li>
            <li class="nav-item">
              <span id="userRole" class="text-white-50 small me-2"></span>
            </li>
            <li class="nav-item">
              <button
                id="logoutBtn"
                class="btn btn-sm btn-outline-light rounded-pill px-4"
              >
                Disconnect
              </button>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- User Management Section -->
    <section class="section-padding pt-5 mt-5 position-relative z-2">
      <div class="container">
        <div class="row mb-5">
          <div class="col-12">
            <h1 class="display-4 fw-bold hero-reveal">
              User Management
            </h1>
            <p class="text-white-50 lead hero-reveal">
              Administer protocol participants and maintain system integrity.
            </p>
          </div>
        </div>

        <!-- Filters and Search -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="glass-card p-4 reveal-up">
              <div class="row g-3 align-items-end">
                <div class="col-md-4">
                  <label class="text-white-50 mb-2">Search Users</label>
                  <input
                    type="text"
                    id="searchInput"
                    class="form-control bg-transparent text-white border-0 border-bottom rounded-0 p-2"
                    placeholder="Search by email or name..."
                  />
                </div>
                <div class="col-md-3">
                  <label class="text-white-50 mb-2">Role Filter</label>
                  <select
                    id="roleFilter"
                    class="form-select bg-transparent text-white border-0 border-bottom rounded-0 p-2"
                  >
                    <option value="" class="bg-dark">All Roles</option>
                    <option value="ADMIN" class="bg-dark">Admin</option>
                    <option value="MERCHANT" class="bg-dark">Merchant</option>
                    <option value="CUSTOMER" class="bg-dark">Customer</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="text-white-50 mb-2">Status</label>
                  <select
                    id="statusFilter"
                    class="form-select bg-transparent text-white border-0 border-bottom rounded-0 p-2"
                  >
                    <option value="" class="bg-dark">All Status</option>
                    <option value="active" class="bg-dark">Active</option>
                    <option value="inactive" class="bg-dark">Inactive</option>
                  </select>
                </div>
                <div class="col-md-3">
                  <button
                    id="applyFilters"
                    class="btn btn-custom btn-lg w-100 magnetic-btn"
                  >
                    Apply Filters
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Users Table -->
        <div class="glass-card p-4 reveal-up">
          <div class="table-responsive">
            <table class="table table-dark table-hover bg-transparent">
              <thead>
                <tr>
                  <th>Email</th>
                  <th>Role</th>
                  <th>Status</th>
                  <th>Joined</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="usersTable">
                <tr>
                  <td colspan="5" class="text-center text-white-50 py-4">
                    Loading users...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Pagination -->
        <div class="row mt-4">
          <div class="col-12 text-center">
            <nav id="paginationNav" aria-label="User pagination">
              <!-- Pagination loaded dynamically -->
            </nav>
          </div>
        </div>
      </div>
    </section>

    <!-- User Edit Modal -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-white border-secondary">
          <div class="modal-header border-secondary">
            <h5 class="modal-title">Edit User</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="editUserForm">
              <div class="mb-3">
                <label class="form-label text-white-50">Email</label>
                <input type="email" id="editEmail" class="form-control bg-transparent text-white border-secondary" readonly>
              </div>
              <div class="mb-3">
                <label class="form-label text-white-50">Role</label>
                <select id="editRole" class="form-select bg-transparent text-white border-secondary">
                  <option value="CUSTOMER" class="bg-dark">Customer</option>
                  <option value="MERCHANT" class="bg-dark">Merchant</option>
                  <option value="ADMIN" class="bg-dark">Admin</option>
                </select>
              </div>
              <div class="mb-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="editIsActive">
                  <label class="form-check-label text-white-50" for="editIsActive">
                    Active User
                  </label>
                </div>
              </div>
            </form>
          </div>
          <div class="modal-footer border-secondary">
            <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-custom" onclick="updateUser()">Update User</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>

    <!-- Custom Script -->
    <script src="script.js"></script>
    <script>
      const API_BASE = 'http://localhost:8000/api';

      // Check authentication
      const token = localStorage.getItem('access_token');
      const user = JSON.parse(localStorage.getItem('user') || '{}');

      if (!token || user.role !== 'ADMIN') {
        window.location.href = 'login.html';
      }

      document.getElementById('userRole').textContent = `${user.role || 'USER'} PROTOCOL`;

      // Logout handler
      document.getElementById('logoutBtn').addEventListener('click', function() {
        localStorage.removeItem('access_token');
        localStorage.removeItem('refresh_token');
        localStorage.removeItem('user');
        window.location.href = 'login.html';
      });

      // API helper with auth
      async function apiCall(endpoint, options = {}) {
        const headers = {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
          ...options.headers
        };

        const response = await fetch(`${API_BASE}${endpoint}`, {
          ...options,
          headers
        });

        if (response.status === 401) {
          localStorage.removeItem('access_token');
          window.location.href = 'login.html';
        }

        return response;
      }

      let currentPage = 1;
      let currentFilters = {
        search: '',
        role: '',
        status: ''
      };
      let currentUserId = null;

      // Load users
      async function loadUsers(page = 1, filters = {}) {
        try {
          let url = `/admin/users/?page=${page}`;
          if (filters.search) url += `&search=${encodeURIComponent(filters.search)}`;
          if (filters.role) url += `&role=${filters.role}`;
          if (filters.status) url += `&is_active=${filters.status === 'active' ? 'true' : 'false'}`;

          const response = await apiCall(url);
          const data = await response.json();

          renderUsers(data.results || data);
          renderPagination(data);
        } catch (error) {
          console.error('Error loading users:', error);
          document.getElementById('usersTable').innerHTML = '<tr><td colspan="5" class="text-center text-danger py-4">Error loading users. Please try again.</td></tr>';
        }
      }

      function renderUsers(users) {
        const table = document.getElementById('usersTable');
        if (users.length === 0) {
          table.innerHTML = '<tr><td colspan="5" class="text-center text-white-50 py-4">No users found matching your criteria.</td></tr>';
        } else {
          table.innerHTML = users.map(u => `
            <tr>
              <td>${u.email}</td>
              <td><span class="badge bg-${getRoleColor(u.role)}">${u.role}</span></td>
              <td><span class="badge bg-${u.is_active ? 'success' : 'secondary'}">${u.is_active ? 'Active' : 'Inactive'}</span></td>
              <td>${new Date(u.date_joined).toLocaleDateString()}</td>
              <td>
                <button class="btn btn-sm btn-outline-light me-2" onclick="editUser(${u.id}, '${u.email}', '${u.role}', ${u.is_active})">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-${u.is_active ? 'warning' : 'success'}" onclick="toggleUserStatus(${u.id}, ${u.is_active})">
                  <i class="bi bi-${u.is_active ? 'pause' : 'play'}"></i>
                </button>
              </td>
            </tr>
          `).join('');
        }
      }

      function getRoleColor(role) {
        switch(role) {
          case 'ADMIN': return 'danger';
          case 'MERCHANT': return 'secondary';
          case 'CUSTOMER': return 'primary';
          default: return 'light';
        }
      }

      function renderPagination(data) {
        const nav = document.getElementById('paginationNav');
        nav.innerHTML = '';
        if (data.next || data.previous) {
          const ul = document.createElement('ul');
          ul.className = 'pagination pagination-lg justify-content-center';

          if (data.previous) {
            ul.innerHTML += `<li class="page-item"><a class="page-link text-white bg-transparent border-secondary" href="#" onclick="changePage(${currentPage - 1})">Previous</a></li>`;
          }

          ul.innerHTML += `<li class="page-item active"><a class="page-link text-white bg-secondary border-secondary" href="#">${currentPage}</a></li>`;

          if (data.next) {
            ul.innerHTML += `<li class="page-item"><a class="page-link text-white bg-transparent border-secondary" href="#" onclick="changePage(${currentPage + 1})">Next</a></li>`;
          }

          nav.appendChild(ul);
        }
      }

      function changePage(page) {
        currentPage = page;
        loadUsers(currentPage, currentFilters);
      }

      // Filter handlers
      document.getElementById('applyFilters').addEventListener('click', function() {
        currentFilters = {
          search: document.getElementById('searchInput').value,
          role: document.getElementById('roleFilter').value,
          status: document.getElementById('statusFilter').value
        };
        currentPage = 1;
        loadUsers(currentPage, currentFilters);
      });

      // Enter key for search
      document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          document.getElementById('applyFilters').click();
        }
      });

      function editUser(id, email, role, isActive) {
        currentUserId = id;
        document.getElementById('editEmail').value = email;
        document.getElementById('editRole').value = role;
        document.getElementById('editIsActive').checked = isActive;

        const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
        modal.show();
      }

      async function updateUser() {
        if (!currentUserId) return;

        const role = document.getElementById('editRole').value;
        const isActive = document.getElementById('editIsActive').checked;

        try {
          const response = await apiCall(`/admin/users/${currentUserId}/`, {
            method: 'PATCH',
            body: JSON.stringify({ role, is_active: isActive })
          });

          if (response.ok) {
            alert('User updated successfully!');
            bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();
            loadUsers(currentPage, currentFilters);
          } else {
            const data = await response.json();
            alert(data.detail || 'Error updating user');
          }
        } catch (error) {
          alert('Connection error. Please try again.');
        }
      }

      async function toggleUserStatus(id, currentStatus) {
        const action = currentStatus ? 'deactivate' : 'activate';
        if (!confirm(`Are you sure you want to ${action} this user?`)) return;

        try {
          const response = await apiCall(`/admin/users/${id}/`, {
            method: 'PATCH',
            body: JSON.stringify({ is_active: !currentStatus })
          });

          if (response.ok) {
            alert(`User ${action}d successfully!`);
            loadUsers(currentPage, currentFilters);
          } else {
            const data = await response.json();
            alert(data.detail || `Error ${action}ing user`);
          }
        } catch (error) {
          alert('Connection error. Please try again.');
        }
      }

      // Initialize
      loadUsers();
    </script>
  </body>
</html>